# Программирование дронов для автономной навигации по видео камерам

Привет! Мы все знаем что такое летающие дроны. Но зачем они нужны автономные и при чем тут видеокамеры - обсудим в этой статье. Потом поговорим, о том, как программировать такие системы, конечно не на низком уровне управления моторами, а на высоком уровне, где мы будем говорить дрону, где он находится и куда ему лететь. Для упрощения разработки для таких штук существуют среда разработки приложение для робототехники ROS (Robot Operating System),  программный симулятор Gazebo (чтобы тестировать алгоритмы в симуляционной среде и в итоге разбить меньше робототехнический средств). И ROS и Gazebo работают в ОС Linux (будем работать в Ubuntu 16.04), и мы в конце настроим такую среду и запустим дрона в симуляторе в автономный полет по заданной траектории. Программа автономного управления будет написана на языке Python. 

### Какие бывают дроны сейчас, как используются

Дроны бывают разные. По конструкции различают мультироторный (коптеры), самолетный (fixed wing) или вообще гибридный тип (взлетает вертикально, потом использует крылья). Также бывают потребительские (consumer) и коммерческие (commercial) дроны. Потребительские - это те, которые можно купить в магазине и использовать как летающую камеру. DJI Phantom, Mavic - хорошие модели. Есть и дешевле - но точно хуже. Такие consumer drones используют многие люди для съемки разных мероприятий, зданий, исторических объектов. Например, с дрона можно получить серию фотографий здания или памятника, а затем создать из них 3D модель объекта методом фотограмметрии.
Как правило, такие дроны летают на ручном управлении, реже по миссии в автономном режиме по GPS координатам. Рынок consumer drones больше чем наполовину принадлежит одной компании - [DJI](https://www.dji.com/). С ними тут очень сложно конкурировать, они делают реально крутой продукт для своих целей: доступный, функциональный, удобный. Хотя в области селфи дронов, я думаю их начинает теснить компания [Skydio](https://www.skydio.com/), со своим дроном R2. Его фишка в том, что он может летать автономно за человеком/мотоциклистом в лесу, видеть все препятствия и прокладывать автономный безопасный маршрут в реальном времени так, чтобы человек всегда оставался в кадре. Реально крутая штука. 

Commercial drones используются уже немного сложнее и не индивидуальными фотографами, а компаниями для решения какой-то задачи. Задач тут огромное количество. Рассмотрим сначала outdoor применения, затем поговорим о применениях внутри помещений. 

Дроны следят за состоянием сельхоз полей, летая над ними регулярно и делая фотографии, другие дроны умеют распылять точечно удобрения на растения - например, на том кусте, где размножились насекомые. Дроны используются на стройках, карьерах. Каждый день они облетают строительный объект, делают фотографии, по которым создается 3D модель в облаке, по которой видны ежедневные изменения состояния строительной площадки, что когда было построено, сколько кубометров песка привезли сегодня, а завтра увезли - на эти вопросы можно получить ответы таким образом. Пример российской компании, которая активно работает с этой технологией на рынке США - [Traceair](http://traceair.net/). Другой пример - осмотр трубопроводов дронами. Это особенно актуально для России - у нас газовые трубопроводы тянутся на тысячи километров, и надо контролировать утечки и врезки. 
Нельзя не коснуться вопроса доставки товаров дронами. Не знаю, заработает ли когда-нибудь сервис [Amazon-Prime-Air](https://www.amazon.com/Amazon-Prime-Air/b?ie=UTF8&node=8037720011), но уже сейчас компания [Matternet](https://mttr.net/) осуществляет доставку товаров в Цюрихе и некоторых городах США, а компания [Zipline](https://www.flyzipline.com/) уже давно доставляет медикаменты над просторами Африки. В России успехов тут пока намного меньше, недавно была новость что [дрон Почты России разбился на первом тесте](https://www.youtube.com/watch?v=SiyaNdqFSDM), а Сбербанк тестирует [доставку денег дронами](https://www.rbc.ru/technology_and_media/16/06/2017/594391f79a79478a62a8409f).
Другой пример - летающее такси, перевозящее людей внутри города. Компании [Volocopter](https://www.volocopter.com/en/) и [Ehang](http://www.ehang.com/ehang184/) уже имеют летающие прототипы такси, а компания с российскими корнями [Hoversurf](https://www.hoversurf.com/) разрабатывает летающий байк.

Indoor тоже есть задачи для коммерческих дронов, но пока они не сильно распространены, в этой области идет интенсивные R&D исследования. Возможные применения для дронов indoor - это
* [Инвентаризация складских помещений](https://flytware.com/)
* [Инспекции строек внутри зданий](https://www.exyn.com/) 
* [Контроль за безопасностью в подземных шахтах](https://emesent.io/)  
* [Инспекции промышленного оборудования в цехах](http://www.fastsense.tech/)

Поживем - увидим, какие проекты будут реализованы и задисраптят нашу жизнь. Вообще наша цель - сделать систему управления дроном, которой герой фильма “Бегущий по лезвию 2049” мог бы сказать: “Сфотографируй тут все!”

![Картинка](https://i.imgur.com/vblDrPb.gif) 


### Автономная навигация 

Коммерческие применения дронов обычно требуют автономного полета, а не ручного управления. Связано это с тем, что часто коммерческие полеты надо выполнять регулярно в одном и том же месте и по одному и тому что полетному плану, который можно запрограммировать и снизить издержки на пилота. 
Для автономного управления дрону надо как минимум знать свои координаты в пространстве с довольно высокой точностью. Для outdoor применений можно использовать GPS, с помощью которого можно получить точность в несколько метров (как у смартфона). Если использовать еще дополнительную наземную станцию и технологию [GPS RTK](https://en.wikipedia.org/wiki/Real-time_kinematic), то можно увеличить точность до нескольких сантиметров. Но наземную станцию не всегда возможно использовать, и это очень дорого. Точности обычного GPS хватает для задания маршрута полета над сельхоз полями, стройками, трубопроводами, и дроны в этих случаях летают автономно. Эта функция есть у любого дрона на рынке. 

В таком режиме безопасно летать только в открытом небе без препятствий. Если речь идет об обследовании зданий, трубопроводов или применение внутри помещений, то тут не обойтись без дополнительных сенсоров, определяющих расстояние до объектов. Такими сенсорами могут быть различные одномерные сонары, лидары, двумерные лидары, 3D лидары и камеры глубины. На борту дрона должен быть установлен дополнительный вычислитель, который должен в реальном времени считывать данные с этих сенсоров, строить 3D модель окружающего пространства и планировать в нем безопасный маршрут. 

Есть еще одна важная проблема - если мы летаем indoor или между высокими зданиями, то GPS сигнал будет недоступен, и необходимо иметь другой источник координат дрона в пространстве. Можно определять свои координаты на борту, обрабатывая видео поток с бортовых камер (лучше стерео камеры или камеры глубины). Алгоритм такой называется SLAM (Simultaneous Localization and Mapping). В двух словах работает следующим образом. В потоке кадров с камеры алгоритм ищет особые точки (features), которыми могут быть маленькие уголки, какие-то неоднородности. Дальше там точкам присваиваются дескрипторы таким образом, что если мы найдем эту же точку в последующих кадрах (когда камера уже успела переместиться в пространстве), то ей будет присвоен такой же дескриптор, и алгоритм сможет сказать: “Вот на этом кадре есть такая же точка, что и на предыдущем”. Тогда трекая (отслеживая) изменения пиксельных координат большого количества таких точек, алгоритм будет решать оптимизационную задачу по перемещению камеры и 3D координатам особых точек, так чтобы минимизировать ошибку репроекции этих точек обратно на матрицу камеры. В итоге получается оценка перемещения камеры в пространстве. Обычно SLAM алгоритм очень требователен к вычислительным ресурсам, но есть камера Intel RealSense T265, внутри которой есть микросхема, реализующая вычисления SLAM на аппаратном уровне.   

Подводя итог, для организации автономного управления дроном необходимо решить три задачи:
* Надо определить координаты дрона в пространстве. Использовать для этого GPS приемник или вычислять на борту координаты, обрабатывая видео поток алгоритмом SLAM. А лучше использовать оба подхода, чтобы знать как глобальные так и локальные координаты дрона
* Надо строить 3D карту окружения дрона с помощью сенсоров типа стерео камер, камер глубины, лидаров и тд.
* Нужен софт для планирования маршрута с учетом цели полета, текущих координат и карты окружения.

### Практика

Ок, с теорией понятно, давай переходить к практике. Мы хотим затестить простую программу управления дроном в автономном режиме. Чтобы ничего не разбить летать будем не на реальном дроне, а в симуляторе на компьютере. Будем использовать следующее открытое программное обеспечение. 

#### Полетный контроллер

Полетный контроллер. Возьмем софт [PX4](https://dev.px4.io/master/en/index.html), на дроне работающий на железке [Pixhawk](https://pixhawk.org/), но имеющий режим Software in the loop (sitl), когда софт работает на Intel x86 CPU, а думает, что он работает на ARM на дроне. Софт при этом получает подменные данные с сенсоров (акселерометры и гироскопы) из симулятора и управляет моделями моторов. Полетный контроллер управляет моторами в зависимости от команд пилота или других данных. У него есть режим внешнего управления OFFBOARD, когда внешний компьютер говорит полетному контроллеру, где он находится в пространстве, и куда ему надо долететь. 

![Fig 1]() 

#### Robot Operating System

Чтобы можно было это сделать, надо иметь много разных программных модулей, одни будут работать с сенсорами, другой будут реализовывать SLAM, третий будет строить 3D карту, четвертый - планировать в ней безопасный маршрут. Для создания этих программных модулей мы используем Robot Operating System (ROS) - распространенный фреймворк для разработки приложений робототехники. Приложение, написанное под ROS, представляет собой набор взаимодействующих пакетов (каждый экземпляр которых называется узел или node). Один из узлов называется мастер (master node) и отвечает за регистрацию остальных узлов приложения. Каждый узел представляет собой отдельный процесс ОС Linux. ROS предоставляет механизм передачи и синхронизации сообщений между узлами, существуют как стандартные сообщения так и определенные программистом. В качестве сообщений могут выступать данные с сенсоров, видеокадры, облака точек, команды управления и передачи параметров. Узлы ROS могут быть запущены на разных машинах - в этом случае взаимодействие между ними осуществляется через сетевой интерфейс. В составе ROS есть специальный узел, называемый rviz, для графической визуализации передаваемых в ROS сообщений, например можно увидеть, как БПЛА видит мир вокруг себя, отобразить траекторию его движения и видеопоток с камеры. 
Для создания пакетов ROS предоставляет возможность использовать языки C++ и Python. 

#### Программный симулятор реального мира Gazebo

Все эти программные средства должны брать данные с сенсоров и управлять чем-то. Программе не важно работать ли с реальными или симуляционными датчиками и актуаторами, поэтому все алгоритмы можно протестировать сначала на компьютере, в мире Gazebo. Gazebo представляет собой симулятор взаимодействия робота с окружающим пространством с качественной 3D графикой, позволяющей увидеть мир и робота как в компьютерной игре, со встроенной модель физики мира и возможностью использовать различные физические датчики, видеокамеры, дальномеры. Есть возможность расширять набор существующих сенсоров путем написания своих плагинов. Измерения сенсоров моделируются с задаваемым уровнем шума. 

В Gazebo возможно использовать значительное количество объектов и готовых зданий в качестве окружающей среды. Присутствуют широкие возможности по изменению существующих объектов и созданию своих. Можно создавать и программные плагины, например модель работы мотора дрона можно создать в виде программы, которая будет будет прикладывать силу тяги к мотору, при поступлении на него управляющего воздействия с полетного контроллера. 

#### Docker образ

Чтобы развернуть у себя на компьютере описанную среду симуляции надо поставить большое количество программных пакетов, и могут быть проблемы с зависимостями. Чтобы сэкономить тебе время я создал docker образ, с уже настроенными пакетами и нужным нам софтом для первого теста дрона в Gazebo.
Найти софт можно тут https://github.com/FastSense/px4_ros_gazebo, заходи и скачивай. Там есть и инструкция по запуску, я ее еще прокомментируют тут.

#### Как будет работать софт управления

В нашем простейшем примере дрон будет летать очень примитивно. Во-первых, источник координат дрона будет не описанный выше SLAM, а симуляционный сигнал GPS. Во-вторых, симуляционный дрон не будет строить карту окружающего пространства. И, наконец, дрон будет летать по заранее заданной траектории. Уже неплохо для первого теста. Работать будем в Ubuntu 16.04. 

### Запуск софта
1. Сначала [установи docker](https://docs.docker.com/install/linux/docker-ce/ubuntu/) и вот эти пакеты
`sudo apt install python-wstool python-catkin-tools -y`
2. Скачай Fast Sense docker образ и софт
```
export FASTSENSE_WORKSPACE_DIR=/home/urock/work/px4
cd $FASTSENSE_WORKSPACE_DIR
mkdir -p catkin_ws/src # сюда будем клонировать ROS модуль управления
mkdir -p Firmware # тут будет скомпилирован код PX4 в режиме sitl
cd catkin_ws/src
git clone git@github.com:FastSense/px4_ros_gazebo.git .
wstool init . # создаёт ROS workspace
```
3. Собери docker образ
```
сd catkin_ws/src
docker build . -t x_kinetic_img # x_kinetic_img - имя создаваемого образа
```
4. Скачай и скомпилируй код PX4 в режиме sitl внутри docker образа
```
сd catkin_ws/src
./docker/docker_x.sh x_kinetic_img make_firmware
# после компиляции должно открыться окошко Gazebo с дроном, лежащим на 
# асфальте

# после каждого запуска docker контейнера его надо убивать
# извини, но с docker я на вы и пока ничего умнее не придумал
docker rm $(docker ps -a -q)
```
![Fig 2]() 

5. Запускай docker контейнер в режиме bash, компилируй и запускай тест
```
сd catkin_ws/src
./docker/docker_x.sh x_kinetic_img bash

# внутри docker контейнера
cd /src/catkin_ws/
catkin build
source devel/setup.bash # это надо сделать только после первой сборки
roslaunch simple_goal simple_goal.launch
```
6. Ты должен увидеть такое же окошко Gazebo, в котором дрон начнет летать. 
В консоле ты должен увидеть вот такой вывод
```
[ INFO] [1577108810.425081938, 19.404000000]: FCU: ARMED by Arm/Disarm component command
[ INFO] [1577108811.792807760, 20.660000000]: FCU: Takeoff detected
```
Тест должен закончится такими строчками:
```
[Testcase: test_posctl] ... ok
-------------------------------------------------------------
SUMMARY:
 * RESULT: SUCCESS
 * TESTS: 1
 * ERRORS: 0 []
 * FAILURES: 0 []
```
На такие ошибки не обращай внимания, их выдает PX4 по какой-то причине
```
[ERROR] [1577108798.707247440, 7.804000000]: ODOM: Ex: Could not find a connection between 'local_origin_ned' and 'fcu' because they are not part of the same tree.Tf has two or more unconnected trees.
```

![Fig 3]() 

Для завершения процесса нажимай Ctrl-C. 

#### Посмотрим на код

Мой Fast Sense репозиторий основан на оригинальных репозиториях от команды, которая разработала PX4 - самый популярный open source полетный контроллер в мире. 
Вот их [инструкция по работе с docker](https://dev.px4.io/master/en/test_and_ci/docker.html) и вот [код модуля автономного управления](https://github.com/PX4/Firmware/blob/master/integrationtests/python_src/px4_it/mavros/mavros_offboard_posctl_test.py), который я перенес в [свой репозиторий](https://github.com/FastSense/px4_ros_gazebo/blob/master/simple_goal/src/simple_goal.py), чтобы было все в одном месте. 

Python код управления совсем небольшой, я уверен, ты сможешь в нем разобраться самостоятельно. Я лишь скажу, что начинать надо с чтения функции 

```def test_posctl(self):```

В ней описана логика полета: дрон переводиться в OFFBOARD режим, затем армится, взлетает и начинает полет по точкам `(0, 0, 0), (5, 5, 2), (5, -5, 2), (-5, -5, 2), (0, 0, 2))`.  
После чего садится и дисармится. 


### Что дальше?
Формат статьи не позволяет рассказать больше об автономных дронах. Тут надо прилагать самостоятельные усилия. 
* Начинать осваивать профессию инженера-программиста-робототехника можно уже со школы. 
* Выбирай ВУЗ, где есть робототехнические кафедры. Если не сможешь поехать в Stanford, MIT и ETH Zurich, то выбирай МФТИ, Сколтех, НГТУ, не хочется обижать другие наши ВУЗы, но в этих трех я знаю сильные команды, занимающиеся дронами.  
* Приходи на стажировку к нам в [Fast Sense](http://www.fastsense.tech/) 
* Собирай команду и участвуй в хакатонах от [COEX](https://copterexpress.timepad.ru/events/), [COEX World Skills](https://coex.tech/cloverws)
* И пиши, задавай вопросы мне лично если есть вопросы по этой статье: urock@fastsense.tech 

